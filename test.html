<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
  <script type="text/javascript" src="../../scripts/js/common.js?version=1.0"></script>
  <script type="text/javascript" src="../../scripts/js/echarts.min.new.js"></script>
  <link href="../../styles/theme/css/default/cmbc.css?version=1.0" rel="stylesheet" type="text/css" />
  <title>智能投顾-产品配置</title>
  <style type="text/css">
    *{
      -webkit-user-select:none;
      user-select:none;
      /* -webkit-tap-highlight-color:transparent; */
      font-family: -apple-system, "SF UI Text", Roboto, Noto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "\5FAE\8F6F\96C5\9ED1", Arial, sans-serif;
    }
    .tabSelected{
      color:#508bed;;font-size:13px;
    }
    .tabSelected div{
      border-bottom:2px solid #508bed;
    }
    .topArea{
      background: url("../../styles/theme/images/zntg/znConfBg2.png") no-repeat;
      background-size:cover;
      background-position:0 -9px;
      height:350px;width:100%;
      position:relative;
    }
    #groupName{
      height:45px;line-height:45px;width:100%;
      font-size:15px;color:#7cdff3;
      text-align:center;
      background-color:transparent;
      position:absolute;top:0;
    }
    .botArea{
      height:220px;width:96%;position:relative;background-color:#fff;
      top:-62px;left:2%;
      -webkit-border-radius:5px;
      -webkit-box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }
    .detail{
      width:50px;height:30px;
      position:absolute;
      left:9px;right:0;
      margin-left:auto;
      margin-right:auto;
      top:124px;
      clear:both;
    }
    .triangle{
      width:0;height:0;
      border-top:5px  solid transparent;
      border-left:5px solid #5b99ff;
      border-bottom:5px solid transparent;
      float:left;margin-top:8px;margin-left:3px;
    }
    .bugDiv1{
      width:100%;background-color: #508bed;line-height: 54px;height:54px;z-index: 101; bottom: 0px; position: fixed
    }
    .bugDiv1:active{
      background-color: #397ceb;
    }
  </style>
</head>
<body class="w320" id="bod1" ontouchstart="" onmouseover="">
<div class="topArea">
  <div id="groupName">
    组合产品配置比例
  </div>
  <div></div>
  <div id="peizhi" style="height:245px;width:100%;"></div>
  <div style="padding:0px 15px 0px 15px;background-color:transparent;height:45px;margin-top:-15px">
    <div class="wf50 f-left center">
      <div style="height:25px;line-height:25px;color:#7cdff3;"><span style="padding-top:4px;">最大回撤</span>
        <img onclick="forInfoMsg1()" alt="" style="position:absolute;height:16px;width:16px;line-height:25px;padding-top:4px;padding-left:2px;" src="../../styles/theme/images/info.png">
      </div><span id="sharpRatio" style=";color:#7cdff3">--</span>
    </div>
    <div class="wf50 f-left center">
      <div style="height:25px;line-height:25px;color:#7cdff3;text-align: center;"><span style="padding-top:4px;">波动率</span>
        <img onclick="forInfoMsg2()" alt="" style="position:absolute;height:16px;width:16px;line-height:25px;padding-top:4px;padding-left:2px;" src="../../styles/theme/images/info.png">
      </div><span id="avgVolatility" style=";color:#7cdff3">--</span>
    </div>
  </div>
  <div class="detail" onclick="toDetailPage()">
    <div style="font-size:16px;color:#5b99ff;float:left">详情</div>
    <div class="triangle"></div>
  </div>
</div>
<div class="botArea" id="klineDiv">
  <div id="tabDiv" class="hiden" style="width:76%;margin-left:12%;line-height:36px;border:none;height:35px;padding-top:6px;float: left;">
    <div class="wf33 f-left center bgWhite tabSelected" onclick="changeTab(this,3)">
      <div style="height:32px;width:45px;margin:auto;color:#508bed;font-size:12px">近3个月</div>
    </div>
    <div class="wf33 f-left center bgWhite" onclick="changeTab(this,6)">
      <div style="height:32px;width:45px;margin:auto;color:#508bed;font-size:12px">近6个月</div>
    </div>
    <div class="wf33 f-left center bgWhite " onclick="changeTab(this,0)">
      <div style="height:32px;width:45px;margin:auto;color:#508bed;font-size:12px">近1年</div>
    </div>
  </div>
  <div id="tabDivI" class="hiden" style="height:35px;padding-top:10px;" >
    <img alt="" onclick="forInfoMsg()" style="height:20px;width:20px;vertical-align:middle;margin-left:10px;" src="../../styles/theme/images/info.png">
  </div>
  <div class="clear"></div>
  <div id="myChart" style="height:170px;width:95%;margin-left:4%;margin-top:2px;background-color: #fff" >
    <div style="padding:10px 5px" id="kLineLabel">数据准备中...</div>
  </div>
</div>
<div style="padding-left:15px;color:#666666;padding-bottom:65px;margin-top:-50px">
  过往业绩不预示未来表现，市场有风险，投资需谨慎。
</div>
<footer class="bugDiv1" onclick="checkTransInfo()">
  <div id="btn1" style="width:100%;height:54px;line-height:54px;
			color:#fff;text-align:center;font-size:17px;">一键购买</div>
</footer>
</body>
<script type="text/javascript">
  //初始化抬头
  function initWebkitTitleBar1(){
    var imgUrl = ctx+"styles/theme/images/zntg/znkefu2.png";
    return '{"title":"投顾方案","leftButton":{"exist":"true","name":"返回","func":"goBack1()"},"rightButton":{"exist":"true","func":"tokefu()","img":"'+imgUrl+'"}}';
  }
  function tokefu(){
    if(clientVersionForOCS>=4.0){
      setWebitEvent("sendMSG3()", "OnlineServerJumpCode");
    }else{
      to(ctx+"page/market/onlineCustomerService/01.html")
    }
  }
  function sendMSG3(){
    var url = ctx+"page/market/onlineCustomerService/01.html";
    return '{"type":"2","url":"'+url+'"}';
  }
  function goBack1(){
    var url=ctx+"page/zntg/ZNHomePage.html?backold="+getQueryStr("backold")+"&minAmtPlan="+getQueryStr("minAmtPlan")+"&RiskLevelPlan="+getQueryStr("RiskLevelPlan");
    to(url);
  }
  function toDetailPage(){
    var url=ctx+"page/zntg/ZNConfDetail.html?groupCode="+groupCode+"&groupVersion="+groupVersion+"&highestRiskLevel="+highestRiskLevel;
    to(url);
  }
  function toOrderPage(){
    var url=ctx+"page/zntg/ZNOrderConfirm.html?groupCode="+groupCode+"&groupVersion="+groupVersion+"&highestRiskLevel="+highestRiskLevel;
    to(url);
  }
  //获取配置详情信息
  var groupCode = getQueryStr("groupCode");
  var groupVersion = getQueryStr("groupVersion");
  var highestRiskLevel = getQueryStr("highestRiskLevel");
  var infoMsg ="";
  function getZNDetailInfo(){
// 	var cfg = "{'msg':'加载中...','callback':''}";
// 	setWaitPanel(cfg);
    if(isEmpty(groupCode)){
      alertinfo("组合id为空！","goBack1()")
      return;
    }
    var sendstr = {
      'portFolioId':groupCode,
      'version':groupVersion,
      TransId : 'ZNDetailInfo'
    };
    var strEncrypt = JsonToStr(sendstr);
    var loadajax = new InfocastAjaxNew();
    loadajax.sendPostData(strEncrypt, function(){
      clearWaitPanel();
      var rpdata = loadajax.getRpdata();
      var code = 	rpdata.ResponseCode;
      var msg = 	rpdata.ResponseMsg;
      if(code=="AAAAAAA"){
        var proInfo = rpdata.respData.detailInfo;
        infoMsg = proInfo.BENCHMARKTIP;
        initEcharts(proInfo);
        g("groupName").innerHTML=isEmpty(proInfo.PORTFOLIONAME)?"组合产品配置比例":proInfo.PORTFOLIONAME+"配比";
      }else{
        alertinfo(msg);
      }
    });
  }

  //初始化配置比例饼图
  function initEcharts(proInfo){
    var myChart = echarts.init(g("peizhi"));
    var legData = proInfo.assetInfo.legData;
    var option={
      color : [
        "#e6d775",
        "#45a3f2",
        "#1feffc",
        "#8190fe",
        "#0cb2d0",
        "#97e68f",
      ],
      backgroundColor:'transparent',
// 		tooltip:{
// 			show:false,
// 			trigger:'item',
// 			formatter: function(params) {//内容格式器
// 				return formatToolTip(params,legData);
// 			}
// 		},
// 		legend:{
// 			orient:'vertical',
// 			left:'52%',
// 			y:'center',
// 			formatter:function(params) {//内容格式器
// 				return formatLegend(params,legData);
// 	 		},
// 			data:legData
// 		},
      series:[{
        name:'配置比例',
        type:'pie',
// 			avoidLabelOverlap:false,//标签防止重叠策略
        radius:['40%','54%'],
        center:['50%','55%'],
        label:{
          normal:{
            show:true,
// 					distance:1,
// 					position:'outside',
// 					textStyle:{
// 						color:'#9ee7f6'
// 					},
// 					formatter:['{a|{c}}{b|%}','{c|{b}}'].join("\n"),
            formatter:['{a|{c}}{b|%}','{c|{b}}'].join(" "),
            rich:{
              a:{
                fontSize:14,
                fontFamily:'Helvetica Neue',
              },
              b:{
                fontSize:12,
              },
              c:{
                fontSize:13,
              }
            }
          },
          emphasis:{
            show:true,
// 					distance:1,
// 					position:'outside',
            textStyle:{
              fontWeight:'bold',
              color:'#fff'
            }
          }
        },
        labelLine:{
          normal:{
            show:true
          }
        },
        data:legData,
        areaStyle:{
          normal:{
            opacity:0.8,
            color:'#7fa5f9'
          }
        }

      }]
    };
    myChart.setOption(option);
  }

  function initOtherInfo(proInfo){
    var Sharpratio = proInfo.SHARPRATIO.replace(/\%/g,"");
    Sharpratio=fmtAmt(Sharpratio)+"%";
    var Avgcolatility = proInfo.AVGVOLATILITY.replace(/\%/g,"");
    Avgcolatility = fmtAmt(Avgcolatility)+"%";
    g("sharpRatio").innerHTML=isEmpty(proInfo.SHARPRATIO)?"--":Sharpratio;
    g("avgVolatility").innerHTML=isEmpty(proInfo.AVGVOLATILITY)?"--":Avgcolatility;
  }

  function formatLegend(params,legData){
    for(var i=0;i<legData.length;i++){
      if(legData[i].name==params){
        return params+" "+fmtAmt(legData[i].value*100)+"%";
      }
    }
  }

  function formatToolTip(params,legData){
    var index = params.dataIndex;
    return legData[index].name+"  "+legData[index].value;
  }

  //下单检查
  function checkTransInfo(){
    var cfg = "{'msg':'加载中...','callback':''}";
    setWaitPanel(cfg);
    var sendstr = {
      'groupCode':groupCode,
      'groupVersion':groupVersion,
      'highestRiskLevel':highestRiskLevel,
      'TransId' : 'ZNQueryRiskMatch'
    };
    var strEncrypt = JsonToStr(sendstr);
    var loadajax = new InfocastAjaxNew();
    loadajax.sendPostData(strEncrypt, function() {
      var rpdata = loadajax.getRpdata();
      var code = 	rpdata.ResponseCode;
      var msg = 	rpdata.ResponseMsg;
      if(code=="AAAAAAA"){
        toOrderPage();
      }else if(code == "ERR9999"){
        setTimeout("sto()",200);
      }else if(code == "F030"){
        var cfg={'title':'提示','msg':'组合中包含基金产品，您尚未签约基金，是否前往签约？',
          'ok_btn':'true','ok_text':'确定','ok_func':'toFundSign()',
          'cancle_text':'取消','cancle_func':''};
        setAlertInfo(JsonToStr(cfg));
      }else if(code == "F000"){
        var cfg={'title':'提示','msg':'未获取到您的评级记录，请重新进行风险评估。',
          'ok_btn':'true','ok_text':'确定','ok_func':'toRiskPage()',
          'cancle_text':'取消','cancle_func':''};
        setAlertInfo(JsonToStr(cfg));
      }else if(code == "F010"){
        var cfg={'title':'提示','msg':'您的风险等级已过期，请重新进行风险评估。',
          'ok_btn':'true','ok_text':'确定','ok_func':'toRiskPage()',
          'cancle_text':'取消','cancle_func':''};
        setAlertInfo(JsonToStr(cfg));
      }else if(code == "F060"){
        var cfg={'title':'提示','msg':'组合的风险等级超过您的风险评估等级，是否继续购买？',
          'ok_btn':'true','ok_text':'确定','ok_func':'toOrderPage()',
          'cancle_text':'取消','cancle_func':''};
        setAlertInfo(JsonToStr(cfg));
      }else if(code == "F020"){
        var cfg={'title':'提示','msg':'组合中有部分产品的风险等级超过您的风险评估等级，是否继续购买？',
          'ok_btn':'true','ok_text':'确定','ok_func':'toOrderPage()',
          'cancle_text':'取消','cancle_func':''};
        setAlertInfo(JsonToStr(cfg));
      }else{
        alertinfo(msg);
      }
      clearWaitPanel()
    });
  }

  function toFundSign(){
    var url=ctx+"app/40/0702/01_O.jsp?groupCode="+groupCode+"&groupVersion="+groupVersion+"&highestRiskLevel="+highestRiskLevel;
    to(url);
  }
  function toRiskPage(){
    var url=ctx+"page/risk/riskAssess.html?groupCode="+groupCode+"&groupVersion="+groupVersion+"&highestRiskLevel="+highestRiskLevel+"&pageType=zntg";
    to(url);
  }
  //k线图
  var kLineInfo;
  function getKlineInfo(){
    var sendstr = {
      'portFolioId':groupCode,
      'version':groupVersion,
      TransId : 'ZNQueryKline'
    };
    var strEncrypt = JsonToStr(sendstr);
    var loadajax = new InfocastAjaxNew();
    loadajax.sendPostData(strEncrypt, function() {
      var rpdata = loadajax.getRpdata();
      var code=rpdata.ResponseCode;
      var msg=rpdata.ResponseMsg;
      if(code=="AAAAAAA"){
        kLineInfo=rpdata.respData;
        drawKLine(3);
        initOtherInfo(kLineInfo);
      }else{
        alertinfo(msg);
      }
    });
  }

  function drawKLine(tNum){
    try{
      var list = kLineInfo.list;
      var num3 = kLineInfo.threeMonthAgoDateNumStr;
      var num6 = kLineInfo.sixMonthAgoDateNumStr;
      if(list.length==0){
        g("kLineLabel").innerHTML="暂无数据"
        return
      }
      removeClass(g("tabDiv"),"hiden");
      removeClass(g("tabDivI"),"hiden");
      if(tNum==3){//近3个月
        list = list.slice(0,num3);
      }else if(tNum==6){//近6个月
        list = list.slice(0,num6);
      }
      //判断显示点的个数
      var kDataNum=getDataShowNum(list.length);
      timeData=getArray(list,'dates',kDataNum);
      xData=getArray(list,'nv',kDataNum);//组合K线
      bmxData=getArray(list,'bmnv',kDataNum);//基准K线
      var interval=getInterval(kDataNum);
      var myChart = echarts.init(g("myChart"));
      var option={
        title:{
          text:'累计收益率',
          textStyle:{
            color:'#666666',
            fontSize:12,
            fontFamily:'Helvetica Neue'
          },
          top:0,
        },
        color:['#f98001'],
        backgroundColor:'#fff',
        grid:{
          show:false,
          top:30,
          right:20,
          bottom:40,
          left:47,
        },
        tooltip:{
          show:true,
          trigger:'axis',
// 			backgroundColor:['red'],//提示框背景色
          textStyle:{

          },
          formatter:function(params) {//内容格式器
            return formatAxisTip(params);
          },
          axisPointer:{//坐标轴指示器
            type:'line',
            axis:'x',
            snap:true,
            lineStyle:{
              color:'#DCDCDC',
              type:'solid',
              opacity:0.3
            },
            label:{//设置坐标轴指示器提示框样式
              show:true,
              margin:7,
              textStyle:{
                color:'white',
              },
              backgroundColor:'#DCDCDC',
              borderWidth:0
            }
          }
        },
        legend:{
          right:10,
          top:3,
          itemWidth:5,
          data:[{
            name:'基准产品业绩',
            icon:'circle'
          },{
            name:'组合产品业绩',
            icon:'circle'
          }],
          textStyle:{
            color:'#999999'
          }
        },
        xAxis:{
          type:'category',
          axisLine:{
            show:false
          },
// 			splitNumber : 2, //分割段数，默认为5
          splitLine:{
            show:true,
            lineStyle:{
              color:['#efefef'],
              type:'solid',
              opacity:0.5
            }
          },
// 			interval:20,
// 			max:'dataMax',
// 			max:function (param){
// 				return timeData[parseInt(param.max)]
// 			},
// 			min:function (param){
// 				return timeData[parseInt(param.min)]
// 			},
          axisLabel:{
            show:true,
            rotate:0,
            textStyle:{
              color:'#999999',
              fontFamily:'Helvetica Neue',
              fontSize:10
            },
            interval:interval,
            showMaxLabel:true,
            showMinLabel:true,
            margin:12
          },
          axisTick:{
            show:false
          },
          boundaryGap:false,
          data:timeData
        },
        yAxis:{
          type:'value',
          axisLine:{
            show:false
          },
          precision:3,
          splitNumber : 4, //分割段数，默认为5
          splitLine:{
            show:true,
            lineStyle:{
              color:['#efefef'],
              type:'solid',
              opacity:0.5
            }
          },
          axisTick:{
            show:false
          },
          axisLabel:{
            show:true,
            textStyle:{
              color:'#999999',
              fontFamily:'Helvetica Neue',
              fontSize:10
            },
            formatter : function(params) {//内容格式器
              return formatAxisLabel(params);
            }
          }
        },
        series:[{
          name:'组合产品业绩',
          type:'line',
          smooth:true,
          showSymbol:false,
          itemStyle:{
            normal:{
              color:'#508bed'
            }
          },
          lineStyle:{
            normal:{
              color:'#508bed'
            }
          },
          data:xData
        },
          {
            name:'基准产品业绩',
            type:'line',
            smooth:true,
            showSymbol:false,
            color:'#508bed',
            itemStyle:{
              normal:{
                color:'#ffab00'
              }
            },
            /* areaStyle:{
             normal:{
             color:'#ffab00'
             }
             }, */
            lineStyle:{
              normal:{
                color:'#ffab00'
              }
            },
            data:bmxData
          }]
      };
      myChart.setOption(option);
    }catch(e){alert(e)};
  }

  //获取显示点的个数
  function getDataShowNum(num){
    var tempNum=parseInt(num)-1;
    var flag=false;
    for(var i=6;i>1;i--){
      if(tempNum%i==0){
        flag=true;
        break;
      }
    }
    if(!flag && parseInt(tempNum)>=7){
      return parseInt(num)-1;
    }else{
      return parseInt(num);
    }
  }
  //获取k线间隔
  function getInterval(num){
    if(num<6){
      return 0;
    }
    var tempNum=parseInt(num)-1;
    for(var i=6;i>1;i--){
      if(tempNum%i==0){
        return parseInt(tempNum/i)-1;
      }
    }
    return 1;
  }

  //获取list中的一个key的value值
  function getArray(list,key,len){
    var array=new Array();
    var length=list.length;
    if(len<=length){
      length=len;
    }
    var r1 = 0;
    var lastBmnv=0;
    for (var i = length-1; i >=0; i--) {
      var item=list[i];
      if(key=="nv"){
        var nv = item.nv;
        if(!isEmpty(nv)){
          r2=(1+parseFloat(r1))*(1+parseFloat(nv))-1
        }
        array.push(r1);
        r1=r2;
      }else if(key=="dates"){
        var daytime=item.dates;
        array.push(daytime);
      }else if(key=="bmnv"){
        var bmnv = item.bmnv;
        if(!isEmpty(bmnv)){
          lastBmnv=bmnv;
          r2=(1+parseFloat(r1))*(1+parseFloat(bmnv))-1
        }else{
          r2=(1+parseFloat(r1))*(1+parseFloat(lastBmnv))-1
        }
        array.push(r1);
        r1=r2;
      }
    }
    return array;
  }
  function formatAxisLabel(value){
    return fmtAmt(value*100)+"%";
  }
  function formatAxisTip(params){
    return "组合业绩:"+formatAxisLabel(params[0].data)+"<br>"+"基准业绩:"+formatAxisLabel(params[1].data)
  }

  function changeTab(obj,num){
    var tabs = g("tabDiv").getElementsByTagName("div");
    for(var i=0;i<tabs.length;i++){
      removeClass(tabs[i],"tabSelected");
    }
    addClass(obj,"tabSelected");
    drawKLine(num);
  }
  function forInfoMsg(){
    alertinfo("组合收益：组合产品的收益计算是按照民生智投推荐产品的比例进行配置的投资组合，并定期进行平衡后产生的累计收益曲线。通常此值越大越好。"+
      "\\n基准收益："+infoMsg
    );
  }
  function forInfoMsg1(){
    alertinfo("最大回撤：在任一时点投资于该组合可能出现的最大亏损的幅度，是风险的重要指标，通常此值越小越好。");
  }
  function forInfoMsg2(){
    alertinfo("波动率：通常指组合产品投资回报率的变化程度的度量，波动率越小代表收益越稳定，通常此值越小越好。");
  }

  //入口函数
  function onReady() {
    setWebitEvent("initWebkitTitleBar1()", "02");
    setTimeout("getZNDetailInfo()",50);
    setTimeout("getKlineInfo()",50);
  }
</script>

</html>
